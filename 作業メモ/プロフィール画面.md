# プロフィールページを作る

使うもの

- tailwindcss
- supabase/ui
- @supabase/supabase-js
- chakra

必要なファイル

- sample.js(作業用の後で消すもので何なら index.js に直書きでもいい)
- ⇧ ある程度形になってから自分は components/Profile.js を作成して丸ごとそちらに移した
- \_app.js

やること

- 各ライブラリをインストール（既にしていたら OK）
- まず項目入力欄を作成（りーべ・ぽぬうさんの作品を主に参考に）
- 各項目に記入できる関数を設定（useState で作っていたが useRef に一部変更）
- 設定した関数を supabase のユーザーデーターベースに渡すように設定
- 一度登録したプロフィールは次確認した時も表示されるようにする（useEfect 使用）
- アイコンをファイルから任意に引けるように設定したい（余裕があれば）
- デザインは今後実装

参考リンク

- [tailwindcss](https://tailwindcss.com/docs/guides/nextjs)
- [chakra](https://chakra-ui.com/docs/getting-started)今は使ってない
- [chakra の icon](https://chakra-ui.com/docs/media-and-icons/avatar)今は使ってない
- [useRef とは](https://qiita.com/seira/items/0e6a2d835f1afb50544d#dom%E3%82%92%E5%8F%82%E7%85%A7%E3%81%97%E3%81%9F%E3%81%84%E5%A0%B4%E5%90%88)
- ["TypeError: Cannot read property 'value' of null" のエラー](https://react.keicode.com/basics/event-pooling.php)
- [Upsert を inser の中で兼ねることができる](https://supabase.io/docs/reference/javascript/insert)
- [りーべ・ぽぬうさんの作品からお知恵を拝借](https://github.com/NiXieePlus/supabase-manga-list-sample)
- [&&や||や!](https://techacademy.jp/magazine/26852)
- [論理演算子で問題文もあり](https://ja.javascript.info/logical-operators)
- [?を使う条件 (三項) 演算子、アリスの例がわかりやすい](https://developer.mozilla.org/ja/docs/Web/JavaScript/Reference/Operators/Conditional_Operator)
- [useCallback はとにかく使え！](https://blog.uhy.ooo/entry/2021-02-23/usecallback-custom-hooks/)
- [useToggle って？](https://dev.classmethod.jp/articles/react-use-toggle/)

```js
// _app.js
import 'tailwindcss/tailwind.css';
import { ChakraProvider } from '@chakra-ui/react';
import { Auth } from '@supabase/ui';
import { supabase } from 'utils/supabaseClient';
function MyApp({ Component, pageProps }) {
  return (
    <ChakraProvider>
      <Auth.UserContextProvider supabaseClient={supabase}>
        <Component {...pageProps} />
      </Auth.UserContextProvider>
    </ChakraProvider>
  );
}

export default MyApp;
```

- chakura-ui は入れたもののまだ使用していない
- Auth.UserContextProvider supabaseClient={supabase}がないとログイン認証してもページ遷移しない（ログイン画面に戻される）

```js
// index.js;

import { supabase } from 'utils/supabaseClient';
import { Auth, Button } from '@supabase/ui';
import { useEffect, useState } from 'react';
import { Profile } from 'components/Profile';

export default function IndexPage() {
  const { user } = Auth.useUser();
  const [prof, setProf] = useState({});
  const logout = async () => {
    const { error } = await supabase.auth.signOut();
    if (error) console.log('Error logging out:', error.message);
  };

  useEffect(() => {
    supabase
      .from('ユーザー')
      .select('*')
      .then((DB) => {
        setProf(DB.data[0]);
      });
  }, [user]);
  console.log(prof);
  return (
    <div className="w-full h-full bg-gray-300  ">
      {!user ? (
        <div className="w-full h-full flex justify-center items-center p-4">
          <Auth
            supabaseClient={supabase}
            providers={['google', 'github']}
            socialLayout="horizontal"
            socialButtonSize="xlarge"
          />
        </div>
      ) : (
        <div
          className="w-full h-full flex flex-col justify-center items-center p-4"
          style={{ minWidth: 250, maxWidth: 600, margin: 'auto' }}
        >
          <Profile logout={logout} uuid={user.id} />
          <Button className="btn-black w-full mt-12" onClick={logout}>
            Logout
          </Button>
        </div>
      )}
    </div>
  );
}
```

```js
// tailwind.config.js
module.exports = {
  mode: 'jit',
  purge: [
    './src/**/*.{js,ts,jsx,tsx}',
    './pages/**/*.{js,ts,jsx,tsx}',
    './components/**/*.{js,ts,jsx,tsx}',
  ],
  darkMode: false, // or 'media' or 'class'
  theme: {
    extend: {},
  },
  variants: {
    extend: {},
  },
  plugins: [],
};
```

- purge は指定しているところ以外での tailwindcss を機能させないようにしている模様
- 今回 components に Profile.js を分けた際に CSS が適用されなかったのは purge に components を指定していなかったせいだった

```js
// Profile.jsx
import { useCallback, useEffect, useRef, useState } from 'react';
import Image from 'next/image';
import { Button } from '@supabase/ui';
import { supabase } from 'utils/supabaseClient';

export const Profile = (props) => {
  const [user, setUser] = useState({});
  const name = useRef(null);
  const age = useRef(null);
  const icon = useRef(null);
  const memo = useRef(null);
  //   const [name, setName] = useState('');
  //   const [age, setAge] = useState('');
  //   const [icon, setIcon] = useState('');
  //   const [memo, setMemo] = useState('');

  const uuid = props.uuid;
  console.log(user);
  //   useCallbackはおまじないです（参考リンク参照、しまぶー神もおっしゃってた気がする）
  const handleAdd = useCallback(
    //   async・awaitは今回だとsupabaseのデータベース（await）以下の作業が終わるまで待てという意味。データが届いてないのに作業を進めると失敗するので
    async (uuid) => {
      if (name.current.value == '') {
        alert('名前を入力してください!');
        return;
      }
      // supabaseのユーザーのテーブルにidカラムにはuuidを、名前カラムにはuserefのname.current.valueを、アイコンカラムにはuserefのicon.current.valueを・・・それぞれ入れ込む（insert）
      const { data, error } = await supabase.from('ユーザー').insert(
        [
          {
            id: uuid,
            名前: name.current.value,
            アイコン: icon.current.value,
            年齢: age.current.value,
            備考: memo.current.value,
          },
        ],
        { upsert: true }
      );
      alert('登録完了');
      alert(uuid);
      alert(name.current.value);
      alert(icon.current.value);
      alert(age.current.value);
      alert(memo.current.value);
    },
    [name, age, icon, memo]
  );
  //   このページが表示されたときにsupabaseのユーザーテーブルの全てのカラムの中でidというカラムの中のuuidという値を持つところ全てからデータ配列の中で一番初めか空を返す
  useEffect(() => {
    supabase
      .from('ユーザー')
      .select('*')
      .eq('id', uuid)
      .then((DB) => setUser(DB.data[0] || {}));
  }, []);
  // このページが表示されたときと、userの情報が更新されるたびににref={name}に名前のデータを、ref={icon}にアイコンのデータを...それぞれ表示する
  useEffect(() => {
    name.current.value = user['名前'];
    icon.current.value = user['アイコン'];
    age.current.value = user['年齢'];
    memo.current.value = user['備考'];
  }, [user]);
  return (
    <div>
      <div as="div" className="fixed inset-0 z-10 overflow-y-auto">
        <div className="min-h-screen px-4 text-center border-2">
          <span
            className="inline-block h-screen align-middle"
            aria-hidden="true"
          >
            &#8203;
          </span>

          <div className="inline-block w-full max-w-md p-6 my-8 overflow-hidden text-left align-middle transition-all transform border border-gray-300 shadow-xl bg-gray-50 rounded-xl">
            <header className="w-20 mx-auto mb-5">
              <Image src="/favicon.ico" width={80} height={80} />
            </header>

            <div
              as="h3"
              className="text-2xl font-medium leading-6 text-center text-gray-900"
            >
              Profile
            </div>
            <div className="grid grid-cols-4 gap-2 mt-4">
              <div className="col-span-1 text-xl text-center">名前</div>
              <input
                className="w-full h-10 col-span-3 p-2 bg-white border border-gray-300 rounded shadow appearance-none hover:border-gray-700"
                ref={name}
              />
            </div>
            <div className="grid grid-cols-4 gap-2 mt-4">
              <div className="col-span-1 text-xl text-center">アイコン</div>
              <input
                className="w-full h-10 col-span-3 p-2 bg-white border border-gray-300 rounded shadow appearance-none hover:border-gray-700"
                ref={icon}
              />
            </div>
            <div className="grid grid-cols-4 gap-2 mt-4">
              <div className="col-span-1 text-xl text-center">年齢</div>
              <input
                className="w-full h-10 col-span-3 p-2 bg-white border border-gray-300 rounded shadow appearance-none hover:border-gray-700"
                ref={age}
              />
            </div>
            <div className="grid grid-cols-4 gap-2 mt-4">
              <div className="col-span-1 text-xl text-center">備考</div>
              <textarea
                className="w-full h-60 col-span-3 p-2 bg-white border border-gray-300 rounded shadow appearance-none hover:border-gray-700"
                ref={memo}
              />
            </div>
            <div className="flex justify-center mt-4">
              <div className="w-32 p-2">
                <Button
                  block
                  type="default"
                  size="large"
                  onClick={props.logout}
                >
                  Cancel
                </Button>
              </div>
              <div className="w-32 p-2">
                <Button block size="large" onClick={() => handleAdd(uuid)}>
                  {user['名前'] ? '更新' : '新規登録'}
                  // userの名前情報があれば更新を表示、なければ新規登録を表示
                </Button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  );
};
```

- components 名は大文字から始めないといけない（小文字にしていて最初エラーが出た）
- insert はカラムへデータを新規追加する構文だが第 2 引数に { upsert: true }とすることで UPDATE もかねることが出来る
- alert はチェックのために使っただけなので消していい（実際に uuid に値が渡ってない時に undefind と通知され判断できた）
- {props.logout}などは Profile コンポーネントの親に当たる index.js から logout={logout}で引いてきている要素
